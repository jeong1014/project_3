<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>í†µí•© ì¸ì‚¬ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        body {
            font-family: 'Malgun Gothic';
            background: #222;
            color: white;
            padding: 20px;
        }

        .container {
            background: #333;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        h2 {
            border-bottom: 2px solid #555;
            padding-bottom: 10px;
            color: #fff;
        }

        input,
        button {
            padding: 8px;
            margin: 5px;
            border-radius: 5px;
            border: none;
        }

        input[type="text"] {
            width: 150px;
        }

        .btn-register {
            background: #2196F3;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: #444;
        }

        th,
        td {
            padding: 10px;
            border-bottom: 1px solid #555;
            text-align: center;
        }

        th {
            color: white;
        }

        .btn-time {
            background: #ff9800;
            color: white;
            cursor: pointer;
        }

        .btn-status {
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }

        .btn-del {
            background: #f44336;
            color: white;
            cursor: pointer;
        }

        #user-table th {
            background: #FF9800;
        }

        #current-table th {
            background: #28a745;
        }

        #log-table th {
            background: #007bff;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>ğŸ‘¤ ì‹ ê·œ ì§ì› ë“±ë¡</h2>
        <input type="text" id="new-name" placeholder="ì´ë¦„">
        <input type="text" id="new-dept" placeholder="ë¶€ì„œ">
        <input type="file" id="new-photo" accept="image/*" style="background: white; color: black;">
        <button class="btn-register" onclick="registerUser()">ë“±ë¡í•˜ê¸°</button>
        <h3 style="margin-top: 20px;">ğŸ“‹ ë“±ë¡ëœ ì§ì› ëª©ë¡</h3>
        <table id="user-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ì´ë¦„</th>
                    <th>ë¶€ì„œ</th>
                    <th>ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="container">
        <h2>ğŸ¢ í˜„ì¬ ì‚¬ë¬´ì‹¤ ê·¼ë¬´ì (Live)</h2>
        <table id="current-table">
            <thead>
                <tr>
                    <th>ì´ë¦„</th>
                    <th>ë¶€ì„œ</th>
                    <th>ì¶œê·¼ ì‹œê°„</th>
                    <th>ìƒíƒœ</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="container">
        <h2>ğŸ“œ ì „ì²´ ì¶œí‡´ê·¼ ê¸°ë¡</h2>
        <table id="log-table">
            <thead>
                <tr>
                    <th>ì´ë¦„</th>
                    <th>ë¶€ì„œ</th>
                    <th>ì¶œê·¼ ì‹œê°„</th>
                    <th>í‡´ê·¼ ì‹œê°„</th>
                    <th>ìƒíƒœ</th>
                    <th style="width: 200px;">ê´€ë¦¬</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        const API_URL = 'https://unanachronous-tacketed-orpha.ngrok-free.dev';

        // 1. ì§ì› ë“±ë¡
        function registerUser() {
            const name = document.getElementById('new-name').value;
            const dept = document.getElementById('new-dept').value;
            const photo = document.getElementById('new-photo').files[0];
            if (!name || !photo) return alert("ì´ë¦„ê³¼ ì‚¬ì§„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤!");

            const formData = new FormData();
            formData.append('name', name);
            formData.append('department', dept);
            formData.append('photo', photo);

            fetch(`${API_URL}/users`, { method: 'POST', body: formData })
                .then(res => res.json())
                .then(data => { alert(data.message); loadUsers(); })
                .catch(err => alert("ë“±ë¡ ì‹¤íŒ¨: " + err));
        }

        function loadUsers() {
            fetch(`${API_URL}/users`).then(res => res.json()).then(data => {
                const tbody = document.querySelector('#user-table tbody');
                tbody.innerHTML = '';
                data.forEach(user => {
                    tbody.innerHTML += `<tr><td>${user.id}</td><td>${user.username}</td><td>${user.department}</td><td><button class="btn-del" onclick="deleteUser(${user.id}, '${user.username}')">í‡´ì‚¬</button></td></tr>`;
                });
            });
        }

        // 2. ì§ì› ì‚­ì œ
        function deleteUser(id, name) {
            if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const creds = getAdminCredentials();
            if (!creds) return;

            fetch(`${API_URL}/users/${id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...creds, username: name })
            }).then(res => res.json()).then(data => { alert(data.message); loadUsers(); })
                .catch(err => alert("ì‚­ì œ ì—ëŸ¬: " + err));
        }

        // 3. ì‹¤ì‹œê°„ í˜„í™©
        function fetchCurrentUsers() {
            fetch(`${API_URL}/current`).then(res => res.json()).then(data => {
                const tbody = document.querySelector('#current-table tbody');
                tbody.innerHTML = '';
                if (data.length === 0) tbody.innerHTML = '<tr><td colspan="4">ì—†ìŒ</td></tr>';
                data.forEach(user => {
                    tbody.innerHTML += `<tr><td><strong>${user.username}</strong></td><td>${user.department}</td><td>${new Date(user.check_in_time).toLocaleTimeString()}</td><td><span style="color:#76ff03;">ğŸŸ¢ ê·¼ë¬´ì¤‘</span></td></tr>`;
                });
            });
        }

        // 4. ì „ì²´ ê¸°ë¡ & ìˆ˜ì •
        function fetchAllLogs() {
            fetch(`${API_URL}/logs`)
                .then(res => res.json())
                .then(data => {
                    const tbody = document.querySelector('#log-table tbody');
                    tbody.innerHTML = '';

                    data.forEach(log => {
                        // 1. ë‚ ì§œ í¬ë§·íŒ… (í™”ë©´ í‘œì‹œìš©)
                        const inTimeObj = new Date(log.check_in_time);
                        const dateStr = inTimeObj.toLocaleString('ko-KR');
                        const outTimeStr = log.check_out_time ? new Date(log.check_out_time).toLocaleTimeString('ko-KR') : '-';

                        // 2. ìˆ˜ì •ìš© ë‚ ì§œ í¬ë§· (YYYY-MM-DD HH:MM:SS) - ì¶œê·¼ìš©
                        const dbInTime = formatDbDate(inTimeObj);

                        // 3. ìˆ˜ì •ìš© ë‚ ì§œ í¬ë§· - í‡´ê·¼ìš© (ì—†ìœ¼ë©´ í˜„ì¬ì‹œê°„ìœ¼ë¡œ ì„¸íŒ…)
                        let dbOutTime = "";
                        if (log.check_out_time) {
                            dbOutTime = formatDbDate(new Date(log.check_out_time));
                        } else {
                            // í‡´ê·¼ ê¸°ë¡ì´ ì—†ìœ¼ë©´, ì¶œê·¼ ë‚ ì§œì— í˜„ì¬ ì‹œê°„ë§Œ ë¶™ì—¬ì„œ ê¸°ë³¸ê°’ ì œì•ˆ
                            const now = new Date();
                            dbOutTime = formatDbDate(now);
                        }

                        tbody.innerHTML += `
                    <tr>
                        <td>${log.username}</td>
                        <td>${log.department}</td>
                        <td>${dateStr}</td>
                        <td>${outTimeStr}</td>
                        <td>${log.status}</td>
                        <td style="white-space: nowrap;">
                            <button class="btn-time" onclick="updateLogTime(${log.log_id}, '${dbInTime}')" title="ì¶œê·¼ ì‹œê°„ ìˆ˜ì •">â°</button>
                            <button style="background: #673AB7; color: white; cursor: pointer;" onclick="updateLogOutTime(${log.log_id}, '${dbOutTime}')" title="í‡´ê·¼ ì‹œê°„ ìˆ˜ì •">ğŸŒ™</button>
                            <button class="btn-status" onclick="updateLogStatus(${log.log_id}, '${log.status}')" title="ìƒíƒœ ìˆ˜ì •">ğŸ“</button>
                            <button class="btn-del" onclick="deleteLog(${log.log_id})" title="ê¸°ë¡ ì‚­ì œ">ğŸ—‘ï¸</button>
                        </td>
                    </tr>`;
                    });
                });
        }
        function formatDbDate(dateObj) {
            return dateObj.getFullYear() + "-" +
                String(dateObj.getMonth() + 1).padStart(2, '0') + "-" +
                String(dateObj.getDate()).padStart(2, '0') + " " +
                String(dateObj.getHours()).padStart(2, '0') + ":" +
                String(dateObj.getMinutes()).padStart(2, '0') + ":" +
                String(dateObj.getSeconds()).padStart(2, '0');
        }
        function getAdminCredentials() {
            const adminId = prompt("ê´€ë¦¬ì ID:");
            if (!adminId) return null;
            const adminPw = prompt("ê´€ë¦¬ì PW:");
            if (!adminPw) return null;
            return { adminId, adminPw };
        }

        function updateLogTime(id, oldTime) {
            const creds = getAdminCredentials();
            if (!creds) return;
            const newTime = prompt("ë³€ê²½í•  'ì¶œê·¼' ì‹œê°„ (YYYY-MM-DD HH:MM:SS):", oldTime);
            if (!newTime) return;
            sendUpdate(id, creds, 'time', newTime);
        }

        function updateLogOutTime(id, oldTime) {
            const creds = getAdminCredentials();
            if (!creds) return;
            const newTime = prompt("ë³€ê²½í•  'í‡´ê·¼' ì‹œê°„ (YYYY-MM-DD HH:MM:SS):", oldTime);
            if (!newTime) return;
            sendUpdate(id, creds, 'out_time', newTime); // íƒ€ì…: out_time
        }
        function updateLogStatus(id, oldStatus) {
            const creds = getAdminCredentials();
            if (!creds) return;
            const newStatus = prompt("ë³€ê²½í•  ìƒíƒœ:", oldStatus);
            if (!newStatus) return;
            sendUpdate(id, creds, 'status', newStatus);
        }

        // í•µì‹¬: ìˆ˜ì • ìš”ì²­ ë³´ë‚´ëŠ” í•¨ìˆ˜ (ì—ëŸ¬ ì²˜ë¦¬ ì¶”ê°€ë¨)
        function sendUpdate(id, creds, type, value) {
            fetch(`${API_URL}/logs/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ ...creds, type, value })
            })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    if (data.success) fetchAllLogs(); // ì„±ê³µ ì‹œ ëª©ë¡ ê°±ì‹ 
                })
                .catch(err => alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜: " + err));
        }

        function deleteLog(id) {
            if (!confirm("ê¸°ë¡ ì‚­ì œ?")) return;
            const creds = getAdminCredentials();
            if (!creds) return;
            fetch(`${API_URL}/logs/${id}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(creds)
            }).then(res => res.json()).then(data => { alert(data.message); fetchAllLogs(); })
                .catch(err => alert("ì‚­ì œ ì˜¤ë¥˜: " + err));
        }

        // ğŸ” ê´€ë¦¬ì ì¸ì¦ í•¨ìˆ˜ (í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ì¦‰ì‹œ ê²€ì‚¬!)
        function getAdminCredentials() {
            const inputId = prompt("ê´€ë¦¬ì ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (!inputId) return null; // ì·¨ì†Œ ëˆ„ë¥´ë©´ ì¢…ë£Œ

            const inputPw = prompt("ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:");
            if (!inputPw) return null; // ì·¨ì†Œ ëˆ„ë¥´ë©´ ì¢…ë£Œ

            // ğŸ”¥ ì—¬ê¸°ì„œ ë°”ë¡œ ê²€ì‚¬! (ì„œë²„ë‘ ë˜‘ê°™ì´ ë§ì¶°ì£¼ì„¸ìš”)
            // ì£¼ì˜: ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„  ì´ë ‡ê²Œ ë¹„ë²ˆì„ ì½”ë“œì— ì ìœ¼ë©´ ìœ„í—˜í•˜ì§€ë§Œ, í¬íŠ¸í´ë¦¬ì˜¤ìš©ìœ¼ë¡  OK!
            const REAL_ID = "admin";
            const REAL_PW = "1234";

            if (inputId !== REAL_ID || inputPw !== REAL_PW) {
                alert("âŒ ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤! (ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”)");
                return null; // í‹€ë ¸ìœ¼ë‹ˆ ì„œë²„ë¡œ ìš”ì²­ë„ ì•ˆ ë³´ëƒ„
            }

            // ë§ìœ¼ë©´ ì •ë³´ ë¦¬í„´
            return { adminId: inputId, adminPw: inputPw };
        }

        loadUsers();
        fetchCurrentUsers();
        fetchAllLogs();
        setInterval(() => { fetchCurrentUsers(); fetchAllLogs(); }, 3000);
    </script>
</body>

</html>